{% load static %}

<!DOCTYPE html>
<html>

<head>
    <title>Music Notation</title>
    <style>
        .note {
            display: inline-block;
            margin: 10px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <h1>Drag and Drop Music Notes</h1>
    <div id="notation"></div>
    <div>C major </div>
    <div id="notes">
        <div class="note" draggable="true" data-note="C/4" data-duration="q">C</div>
        <div class="note" draggable="true" data-note="D/4" data-duration="q">D</div>
        <div class="note" draggable="true" data-note="E/4" data-duration="q">E</div>
        <div class="note" draggable="true" data-note="F/4" data-duration="q">F</div>
        <div class="note" draggable="true" data-note="G/4" data-duration="q">G</div>
        <div class="note" draggable="true" data-note="A/4" data-duration="q">A</div>
        <div class="note" draggable="true" data-note="B/4" data-duration="q">B</div>
        <div class="note" draggable="true" data-note="C/5" data-duration="q">C</div>
    </div>


    <script src="{% static 'HelloMusicApp/js/vexflow.js' %}"></script>
    <script src="{% static 'HelloMusicApp/js/Tone.js' %}"></script>
    <script>
        // Render blank staff
        const VF = Vex.Flow;
        const div = document.getElementById("notation");
        const renderer = new VF.Renderer(div, VF.Renderer.Backends.SVG);
        renderer.resize(500, 200);

        const context = renderer.getContext();
        const stave = new VF.Stave(10, 40, 400);
        stave.addClef("treble").setContext(context).draw();

        // Add drag-and-drop functionality
        const notes = document.querySelectorAll(".note");
        let notesArray = [];

        notes.forEach(note => {
            note.addEventListener("dragstart", (e) => {
                e.dataTransfer.setData("note", JSON.stringify({
                    pitch: e.target.dataset.note,
                    duration: e.target.dataset.duration
                }));
            });
        });


        div.addEventListener("dragover", (e) => {
            e.preventDefault();
        });

        div.addEventListener("drop", (e) => {
            e.preventDefault();

            const data = JSON.parse(e.dataTransfer.getData("note"));

            // Add the note to the notes array
            notesArray.push(new VF.StaveNote({
                clef: "treble",
                keys: [data.pitch.toLowerCase()],
                duration: data.duration
            }));

            console.log("Notes Array:", notesArray);

            // Re-render the staff with all notes
            renderStaff();
            playnote();

        });

        function renderStaff() {
            // Clear the previous rendering
            context.clear();

            // Redraw the staff
            stave.setContext(context).draw();

            // Create a new voice with the notes
            const voice = new VF.Voice({
                num_beats: notesArray.length,
                beat_value: 4,
                partialMeasure: true // Ignore incomplete voice
            }).addTickables(notesArray);

            // Format and render the notes
            const formatter = new VF.Formatter().joinVoices([voice]).format([voice], 400);
            voice.draw(context, stave);

        }

        function playnote() {
            // Create a Tone.js synth
            const synth = new Tone.Synth().toDestination();

            let time = Tone.now();
            console.log("Playing note at time:", time);
            // Play each note
            notesArray.forEach((note) => {
                const pitch = note.keys[0].replace("/", ""); // Replace "/" with an empty string
                let duration;

                // Map VexFlow durations to Tone.js durations
                switch (note.duration) {
                    case "w":
                        duration = "1n";
                        break; // Whole note
                    case "h":
                        duration = "2n";
                        break; // Half note
                    case "q":
                        duration = "4n";
                        break; // Quarter note
                    case "8":
                        duration = "8n";
                        break; // Eighth note
                    default:
                        duration = "4n"; // Fallback to quarter note
                }

                // Schedule the note with Tone.js
                console.log("Playing note:", pitch, "Duration:", duration, "At time:", time);

                synth.triggerAttackRelease(pitch, duration, time);
 
                // Start the Tone.js Transport to play the notes
                time += Tone.Time(duration).toSeconds();
            

            });
        }
    </script>
</body>

</html>